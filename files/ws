package main

import (
	"bufio"
	"io"
	"net"
	"os"
	"strings"
)

const (
	// Langsung dengerin di port 80
	ListenPort = "80" 
	// Lempar ke SSH Lokal
	SSHPort    = "127.0.0.1:22" 
	BannerPath = "/etc/yinn_banner.txt"
	DefBanner  = "HTTP/1.1 101 Switching Protocols\r\nUpgrade: websocket\r\nConnection: Upgrade\r\n\r\n"
)

func getBanner() []byte {
	content, err := os.ReadFile(BannerPath)
	if err != nil {
		return []byte(DefBanner)
	}
	banner := strings.ReplaceAll(string(content), "[crlf]", "\r\n")
	if !strings.HasSuffix(banner, "\r\n\r\n") {
		banner += "\r\n\r\n"
	}
	return []byte(banner)
}

func proxy(src, dst net.Conn) {
	defer src.Close()
	defer dst.Close()
	io.Copy(src, dst)
}

func handleClient(clientConn net.Conn) {
	// Jangan tutup dulu karena mau di-handshake
	reader := bufio.NewReader(clientConn)
	
	// Intip (Peek) data tanpa membuangnya
	// Kita cek apakah ini HTTP Request atau bukan
	line, err := reader.ReadString('\n')
	if err != nil {
		clientConn.Close()
		return
	}

	// Logic: Jika request mengandung "Upgrade: websocket" atau "GET"
	// Kita anggap ini SSH Websocket
	if strings.Contains(strings.ToLower(line), "get") || strings.Contains(strings.ToLower(line), "upgrade") {
		// Kirim Banner
		clientConn.Write(getBanner())

		// Hubungkan ke SSH
		targetConn, err := net.Dial("tcp", SSHPort)
		if err != nil {
			clientConn.Close()
			return
		}
		
		go proxy(clientConn, targetConn)
		proxy(targetConn, clientConn)
	} else {
		// Jika trafik lain, abaikan atau bisa lu arahkan ke port lain
		clientConn.Close()
	}
}

func main() {
	// Listen di Port 80
	ln, err := net.Listen("tcp", ":"+ListenPort)
	if err != nil {
		// Jika port 80 gagal (mungkin dipakai Nginx), kita coba port lain
		// Tapi lu bilang "tanpa sentuh file lain", berarti Nginx di script lu
		// portnya harus dipindah ke 81 atau lainnya di file installer.
		os.Exit(1)
	}

	for {
		conn, err := ln.Accept()
		if err != nil {
			continue
		}
		go handleClient(conn)
	}
}
