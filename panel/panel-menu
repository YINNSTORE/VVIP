#!/bin/bash
set -e

# =========================
# THEME / COLORS
# =========================
C_RESET="\033[0m"
C_DIM="\033[2m"
C_BOLD="\033[1m"

C_RED="\033[0;31m"
C_GREEN="\033[0;32m"
C_YELLOW="\033[1;33m"
C_CYAN="\033[0;36m"
C_BLUE="\033[0;34m"
C_WHITE="\033[1;97m"

B_BG="\033[48;5;235m"
B_CARD="\033[48;5;236m"

HR="‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

# =========================
# PATHS
# =========================
DOMAIN_FILE="/etc/xray/domain"

PANEL_DIR="/opt/yinnpanel"
APP_FILE="$PANEL_DIR/app.py"
ADMIN_DIR="/var/www/yinnpanel-admin"

ENV_FILE="/etc/yinnpanel.env"
SVC_FILE="/etc/systemd/system/yinnpanel.service"
SUDOERS_FILE="/etc/sudoers.d/yinnpanel"

NGINX_FILE="/etc/nginx/conf.d/yinnpanel.conf"

API_PORT="9001"
API_BIND="127.0.0.1"

# Subdomain
PANEL_SUB="panel"   # panel.domain.tld

# =========================
# HELPERS
# =========================
have_cmd() { command -v "$1" >/dev/null 2>&1; }

get_domain() {
  if [ -f "$DOMAIN_FILE" ]; then
    cat "$DOMAIN_FILE" | tr -d ' \n\r'
  fi
}

get_panel_host() {
  local d
  d="$(get_domain)"
  [ -n "$d" ] && echo "${PANEL_SUB}.${d}"
}

banner() {
  echo -e "${B_BG}${C_WHITE}${C_BOLD}   üü† YINN WEB PANEL   ${C_RESET}"
  echo -e "${C_DIM}${HR}${C_RESET}"
}

card() {
  echo -e "${B_CARD}${C_WHITE}${C_BOLD} $1 ${C_RESET}"
}

status_line() {
  if systemctl is-active --quiet yinnpanel 2>/dev/null; then
    echo -e "${C_GREEN}${C_BOLD}RUNNING${C_RESET}"
  else
    echo -e "${C_RED}${C_BOLD}STOPPED${C_RESET}"
  fi
}

panel_installed() {
  [ -d "$PANEL_DIR" ] && [ -f "$APP_FILE" ] && [ -f "$SVC_FILE" ] && [ -f "$ENV_FILE" ]
}

gen_token() {
  python3 - <<'PY'
import secrets
print(secrets.token_urlsafe(32))
PY
}

show_token() {
  if [ -f "$ENV_FILE" ]; then
    grep -oP '^PANEL_TOKEN=\K.*' "$ENV_FILE" || true
  fi
}

ensure_user_panel() {
  if ! id panel >/dev/null 2>&1; then
    useradd -r -m -d /opt/yinnpanel -s /usr/sbin/nologin panel || true
  fi
}

ensure_base_deps() {
  have_cmd python3 || { echo -e "${C_RED}python3 belum ada${C_RESET}"; exit 1; }
  have_cmd nginx  || { echo -e "${C_RED}nginx belum ada${C_RESET}"; exit 1; }

  apt-get update -y >/dev/null 2>&1 || true
  apt-get install -y python3-venv python3-pip curl jq >/dev/null 2>&1 || true
}

write_app_from_github() {
  mkdir -p "$PANEL_DIR"
  curl -fsSL "https://raw.githubusercontent.com/YINNSTORE/VVIP/main/panel/app.py" -o "$APP_FILE"
  chown -R panel:panel "$PANEL_DIR"
  chmod 755 "$PANEL_DIR"
}

write_admin_from_github() {
  mkdir -p "$ADMIN_DIR"
  curl -fsSL "https://raw.githubusercontent.com/YINNSTORE/VVIP/main/panel/admin/index.html" -o "$ADMIN_DIR/index.html"
  chown -R www-data:www-data "$ADMIN_DIR" 2>/dev/null || true
  chmod -R 755 "$ADMIN_DIR"
}

write_env_if_missing() {
  if [ ! -f "$ENV_FILE" ]; then
    local t
    t="$(gen_token)"
    echo "PANEL_TOKEN=${t}" > "$ENV_FILE"
    chmod 600 "$ENV_FILE"
  fi
}

rotate_token() {
  local t
  t="$(gen_token)"
  echo "PANEL_TOKEN=${t}" > "$ENV_FILE"
  chmod 600 "$ENV_FILE"
  systemctl restart yinnpanel >/dev/null 2>&1 || true
  echo -e "${C_GREEN}${C_BOLD}TOKEN BARU:${C_RESET} ${t}"
}

revoke_token() {
  echo "PANEL_TOKEN=" > "$ENV_FILE"
  chmod 600 "$ENV_FILE"
  systemctl restart yinnpanel >/dev/null 2>&1 || true
  echo -e "${C_YELLOW}${C_BOLD}TOKEN DI-REVOKE:${C_RESET} dikosongkan"
}

ensure_sudo_rule() {
  cat > "$SUDOERS_FILE" <<'EOF'
panel ALL=(root) NOPASSWD: /usr/local/sbin/addssh, /usr/local/sbin/addws, /usr/local/sbin/addvless, /usr/local/sbin/addtr
Defaults:panel !requiretty
EOF
  chmod 440 "$SUDOERS_FILE"
}

ensure_service() {
  cat > "$SVC_FILE" <<EOF
[Unit]
Description=Yinn Panel API
After=network.target

[Service]
User=panel
Group=panel
EnvironmentFile=$ENV_FILE
WorkingDirectory=$PANEL_DIR
ExecStart=$PANEL_DIR/venv/bin/uvicorn app:app --host $API_BIND --port $API_PORT
Restart=always
RestartSec=2

[Install]
WantedBy=multi-user.target
EOF
}

ensure_venv() {
  mkdir -p "$PANEL_DIR"
  chown -R panel:panel "$PANEL_DIR"

  if [ ! -d "$PANEL_DIR/venv" ]; then
    sudo -u panel python3 -m venv "$PANEL_DIR/venv"
  fi

  sudo -u panel "$PANEL_DIR/venv/bin/pip" install --upgrade pip >/dev/null 2>&1 || true
  sudo -u panel "$PANEL_DIR/venv/bin/pip" install fastapi "uvicorn[standard]" >/dev/null 2>&1
}

ensure_nginx_subdomain() {
  local d host
  d="$(get_domain)"
  host="$(get_panel_host)"

  if [ -z "$d" ] || [ -z "$host" ]; then
    echo -e "${C_RED}Domain tidak ketemu di $DOMAIN_FILE${C_RESET}"
    return 1
  fi

  cat > "$NGINX_FILE" <<EOF
# YINN PANEL - SUBDOMAIN (safe include)
server {
    listen 80;
    server_name $host;

    # Admin UI
    location / {
        root $ADMIN_DIR;
        index index.html;
        try_files \$uri \$uri/ /index.html;
    }

    # API reverse proxy
    location ^~ /api/ {
        proxy_pass http://$API_BIND:$API_PORT;
        proxy_http_version 1.1;

        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        proxy_set_header Authorization \$http_authorization;

        proxy_connect_timeout 3s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Docs & OpenAPI (optional)
    location ^~ /docs {
        proxy_pass http://$API_BIND:$API_PORT/docs;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header Authorization \$http_authorization;
    }
    location = /openapi.json {
        proxy_pass http://$API_BIND:$API_PORT/openapi.json;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header Authorization \$http_authorization;
    }

    # Health
    location = /health {
        proxy_pass http://$API_BIND:$API_PORT/health;
        proxy_http_version 1.1;
        proxy_set_header Host \$host;
        proxy_set_header Authorization \$http_authorization;
    }
}
EOF

  if nginx -t >/dev/null 2>&1; then
    systemctl reload nginx >/dev/null 2>&1 || true
    echo -e "${C_GREEN}${C_BOLD}OK:${C_RESET} nginx panel subdomain aktif"
  else
    echo -e "${C_RED}${C_BOLD}NGINX ERROR:${C_RESET} cek file $NGINX_FILE"
    nginx -t || true
    return 1
  fi
}

install_panel() {
  banner
  echo -e "${C_YELLOW}${C_BOLD}Install YinnPanel (API + Admin Web)${C_RESET}"
  echo -e "${C_DIM}${HR}${C_RESET}"

  ensure_base_deps
  ensure_user_panel
  ensure_venv

  write_app_from_github
  write_admin_from_github
  write_env_if_missing
  ensure_sudo_rule
  ensure_service

  systemctl daemon-reload
  systemctl enable --now yinnpanel >/dev/null 2>&1 || true

  ensure_nginx_subdomain

  echo ""
  card "INFO"
  echo -e "Domain Script : $(get_domain)"
  echo -e "Panel Host    : $(get_panel_host)"
  echo -e "Status        : $(status_line)"
  echo -e "Admin URL     : http://$(get_panel_host)/"
  echo -e "Docs URL      : http://$(get_panel_host)/docs"
  echo -e "Token         : $(show_token)"
}

uninstall_panel() {
  banner
  echo -e "${C_YELLOW}${C_BOLD}Uninstall YinnPanel...${C_RESET}"
  systemctl disable --now yinnpanel >/dev/null 2>&1 || true
  rm -f "$SVC_FILE" "$SUDOERS_FILE" "$NGINX_FILE" "$ENV_FILE"
  rm -rf "$PANEL_DIR" "$ADMIN_DIR"
  systemctl daemon-reload >/dev/null 2>&1 || true
  nginx -t >/dev/null 2>&1 && systemctl reload nginx >/dev/null 2>&1 || true
  echo -e "${C_GREEN}${C_BOLD}Done.${C_RESET}"
}

show_info() {
  local d host t
  d="$(get_domain)"
  host="$(get_panel_host)"
  t="$(show_token)"

  banner
  card "YINN PANEL INFO"
  echo -e "Domain Script : ${d:-'-'}"
  echo -e "Panel Host    : ${host:-'-'}"
  echo -e "Service       : $(status_line)"
  echo -e "Local API     : http://127.0.0.1:${API_PORT}/health"
  echo -e "Public Health : http://${host:-HOST}/health"
  echo -e "Docs          : http://${host:-HOST}/docs"
  echo -e "Token         : ${t:-'(kosong / revoked)'}"
}

start_panel()  { systemctl start yinnpanel;  echo -e "${C_GREEN}Started.${C_RESET}"; }
stop_panel()   { systemctl stop yinnpanel;   echo -e "${C_YELLOW}Stopped.${C_RESET}"; }
restart_panel(){ systemctl restart yinnpanel; echo -e "${C_GREEN}Restarted.${C_RESET}"; }

setup_nginx() { ensure_nginx_subdomain; }

# =========================
# MENU LOOP
# =========================
while true; do
  clear
  banner

  echo -e "${C_WHITE}Status : ${C_RESET}$(status_line)"
  echo -e "${C_WHITE}Domain : ${C_RESET}$(get_domain)"
  echo -e "${C_WHITE}Host   : ${C_RESET}$(get_panel_host)"
  echo -e "${C_DIM}${HR}${C_RESET}"

  echo -e "${C_CYAN}[01]${C_RESET} Install Panel (API + Admin Web)"
  echo -e "${C_CYAN}[02]${C_RESET} Info / Show Token"
  echo -e "${C_CYAN}[03]${C_RESET} Start Panel"
  echo -e "${C_CYAN}[04]${C_RESET} Stop Panel"
  echo -e "${C_CYAN}[05]${C_RESET} Restart Panel"
  echo -e "${C_CYAN}[06]${C_RESET} Rotate Token (Revoke lama)"
  echo -e "${C_CYAN}[07]${C_RESET} Revoke Token (Kosongkan)"
  echo -e "${C_CYAN}[08]${C_RESET} Setup Nginx Subdomain (panel.domain)"
  echo -e "${C_CYAN}[09]${C_RESET} Uninstall Panel"
  echo -e "${C_CYAN}[00]${C_RESET} Back"
  echo -e "${C_DIM}${HR}${C_RESET}"
  read -p "Select ‚ü© " opt

  case "$opt" in
    1|01) clear; install_panel; read -p "Enter untuk balik..." ;;
    2|02) clear; show_info; read -p "Enter untuk balik..." ;;
    3|03) clear; start_panel; sleep 1 ;;
    4|04) clear; stop_panel; sleep 1 ;;
    5|05) clear; restart_panel; sleep 1 ;;
    6|06) clear; rotate_token; read -p "Enter untuk balik..." ;;
    7|07) clear; revoke_token; read -p "Enter untuk balik..." ;;
    8|08) clear; setup_nginx; read -p "Enter untuk balik..." ;;
    9|09) clear; uninstall_panel; read -p "Enter untuk balik..." ;;
    0|00) clear; menu-x; exit 0 ;;
    *) echo -e "${C_RED}Invalid.${C_RESET}"; sleep 1 ;;
  esac
done